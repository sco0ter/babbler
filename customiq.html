<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 from src/site/markdown/customiq.md at 2023-01-08
 | Rendered using Apache Maven Fluido Skin 1.7
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20230108" />
    <meta http-equiv="Content-Language" content="en" />
    <title>XMPP.rocks - Documentation &#x2013; Custom IQs</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.7.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
    <script type="text/javascript" src="./js/apache-maven-fluido-1.7.min.js"></script>
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>XMPP.rocks - Documentation</h2>
</div>
</div>
        <div class="pull-right"><div id="bannerRight"><img src="xmpp.png"  alt="XMPP.rocks - Documentation"/></div>
</div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2023-01-08<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 0.9.1</li>
      <li class="pull-right"><span class="divider">|</span>
<a href="https://bitbucket.org/sco0ter/babbler/downloads" class="externalLink" title="Binaries">Binaries</a></li>
      <li class="pull-right"><a href="https://bitbucket.org/sco0ter/babbler/src" class="externalLink" title="Source Code">Source Code</a></li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
    <ul class="nav nav-list">
      <li class="nav-header">Project Information</li>
    <li><a href="index.html" title="About"><span class="none"></span>About</a></li>
    <li><a href="xeps.html" title="Supported Specifications"><span class="none"></span>Supported Specifications</a></li>
    <li><a href="license.html" title="License"><span class="none"></span>License</a></li>
    <li><a href="changelog.html" title="Changelog"><span class="none"></span>Changelog</a></li>
    <li><a href="releasenotes.html" title="Release Notes"><span class="none"></span>Release Notes</a></li>
      <li class="nav-header">User Guide</li>
    <li><a href="basics.html" title="Getting Started"><span class="none"></span>Getting Started</a></li>
    <li><a href="basic-concepts.html" title="Basic Concepts"><span class="none"></span>Basic Concepts</a></li>
    <li><a href="im.html" title="Contacts, Presence and Messaging"><span class="none"></span>Contacts, Presence and Messaging</a></li>
    <li><a href="extensions.html" title="Using Extensions"><span class="none"></span>Using Extensions</a></li>
    <li><a href="customextensions.html" title="Writing Custom Extensions"><span class="none"></span>Writing Custom Extensions</a></li>
    <li class="active"><a href="#"><span class="none"></span>Custom IQs</a></li>
    <li><a href="customauthentication.html" title="Custom Authentication"><span class="none"></span>Custom Authentication</a></li>
    <li><a href="errors.html" title="Exceptions and XMPP Errors"><span class="none"></span>Exceptions and XMPP Errors</a></li>
    <li><a href="reconnection.html" title="Dis- and Reconnection"><span class="none"></span>Dis- and Reconnection</a></li>
    <li><a href="debugging.html" title="Debugging XMPP Traffic"><span class="none"></span>Debugging XMPP Traffic</a></li>
    <li><a href="buildinstructions.html" title="Build Instructions"><span class="none"></span>Build Instructions</a></li>
      <li class="nav-header">Extension Guide</li>
    <li><a href="xep/filetransfer.html" title="File Transfer"><span class="none"></span>File Transfer</a></li>
    <li><a href="xep/avatar.html" title="Avatars"><span class="none"></span>Avatars</a></li>
    <li><a href="xep/httpbind.html" title="HTTP Binding / BOSH"><span class="none"></span>HTTP Binding / BOSH</a></li>
    <li><a href="xep/externalcomponents.html" title="External Components"><span class="none"></span>External Components</a></li>
    <li><a href="xep/rpc.html" title="XEP-0009: Jabber-RPC"><span class="none"></span>XEP-0009: Jabber-RPC</a></li>
    <li><a href="xep/last.html" title="Last Activity and Idle Time"><span class="none"></span>Last Activity and Idle Time</a></li>
    <li><a href="xep/privacy.html" title="XEP-0016: Privacy Lists"><span class="none"></span>XEP-0016: Privacy Lists</a></li>
    <li><a href="xep/disco.html" title="XEP-0030: Service Discovery"><span class="none"></span>XEP-0030: Service Discovery</a></li>
    <li><a href="xep/muc.html" title="XEP-0045: Multi-User Chat"><span class="none"></span>XEP-0045: Multi-User Chat</a></li>
    <li><a href="xep/bookmarks.html" title="XEP-0048: Bookmarks"><span class="none"></span>XEP-0048: Bookmarks</a></li>
    <li><a href="xep/vcard.html" title="XEP-0054: vcard-temp"><span class="none"></span>XEP-0054: vcard-temp</a></li>
    <li><a href="xep/pubsub.html" title="XEP-0060: Publish-Subscribe"><span class="none"></span>XEP-0060: Publish-Subscribe</a></li>
    <li><a href="xep/xhtmlim.html" title="XEP-0071: XHTML-IM"><span class="none"></span>XEP-0071: XHTML-IM</a></li>
    <li><a href="xep/soap.html" title="XEP-0072: SOAP Over XMPP"><span class="none"></span>XEP-0072: SOAP Over XMPP</a></li>
    <li><a href="xep/amp.html" title="XEP-0079: Advanced Message Processing"><span class="none"></span>XEP-0079: Advanced Message Processing</a></li>
    <li><a href="xep/geoloc.html" title="XEP-0080: User Location"><span class="none"></span>XEP-0080: User Location</a></li>
    <li><a href="xep/version.html" title="XEP-0092: Software Version"><span class="none"></span>XEP-0092: Software Version</a></li>
    <li><a href="xep/rosterx.html" title="XEP-0144: Roster Item Exchange"><span class="none"></span>XEP-0144: Roster Item Exchange</a></li>
    <li><a href="xep/pep.html" title="XEP-0163: Personal Eventing Protocol"><span class="none"></span>XEP-0163: Personal Eventing Protocol</a></li>
    <li><a href="xep/receipts.html" title="XEP-0184: Message Delivery Receipts"><span class="none"></span>XEP-0184: Message Delivery Receipts</a></li>
    <li><a href="xep/time.html" title="XEP-0202: Entity Time"><span class="none"></span>XEP-0202: Entity Time</a></li>
    <li><a href="xep/delay.html" title="XEP-0203: Delayed Delivery"><span class="none"></span>XEP-0203: Delayed Delivery</a></li>
    <li><a href="xep/carbons.html" title="XEP-0280: Message Carbons"><span class="none"></span>XEP-0280: Message Carbons</a></li>
    <li><a href="xep/rtt.html" title="XEP-0301: In-Band Real Time Text"><span class="none"></span>XEP-0301: In-Band Real Time Text</a></li>
    <li><a href="xep/message-correct.html" title="XEP-0308: Last Message Correction"><span class="none"></span>XEP-0308: Last Message Correction</a></li>
      <li class="nav-header">API Documentation</li>
    <li><a href="apidocs/index.html" title="JavaDoc"><span class="none"></span>JavaDoc</a></li>
</ul>
          <hr />
          <div id="poweredBy">
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
<a href="" title="" class="builtBy"><img class="builtBy"  alt="" src=""    /></a>
            </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span9" >
<h1>Custom IQs</h1><hr />
<p>The IQ semantic is a simple request-response mechanism. One entity requests another entity (with a specific payload) and
the responder returns a result. Writing custom IQs (and the handling of those) is easy.</p>
<p>Here's a simple example, which allows one entity to request the sum of two integers. The responding entity calculates
the result and returns it to the requester.</p><section>
<h2><a name="Writing_the_Custom_Payload_Class"></a>Writing the Custom Payload Class</h2>
<p>First write your payload class and annotate it with JAXB annotations. Make sure to mark it with <code>@XmlRootElement</code>:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">@XmlRootElement(name = &quot;addition&quot;)
public final class Addition {

    @XmlElement(name = &quot;summand1&quot;)
    private Integer summand1;

    @XmlElement(name = &quot;summand2&quot;)
    private Integer summand2;

    @XmlElement(name = &quot;sum&quot;)
    private Integer sum;

    /**
     * No-arg default constructor needed for JAXB.
     */
    private Addition() {
    }

    public Addition(Integer summand1, Integer summand2) {
        this.summand1 = Objects.requireNonNull(summand1);
        this.summand2 = Objects.requireNonNull(summand2);
    }

    public Addition(Integer sum) {
        this.sum = Objects.requireNonNull(sum);
    }

    public Integer getSummand1() {
        return summand1;
    }

    public Integer getSummand2() {
        return summand2;
    }

    @Override
    public String toString() {
        if (summand1 != null &amp;&amp; summand2 != null) {
            return summand1 + &quot; + &quot; + summand2 + &quot; = ???&quot;;
        }
        return &quot;Sum: &quot; + sum;
    }
}
</code></pre></div>
<p>Then create a <i>package-info.java</i> in the same package as your JAXB annotated class:</p>

<div class="source"><pre class="prettyprint"><code>@XmlAccessorType(XmlAccessType.FIELD)
@XmlSchema(namespace = &quot;http://xmpp.rocks&quot;, elementFormDefault = XmlNsForm.QUALIFIED)
package rocks.xmpp.sample.customiq;

import javax.xml.bind.annotation.XmlAccessType;
import javax.xml.bind.annotation.XmlAccessorType;
import javax.xml.bind.annotation.XmlNsForm;
import javax.xml.bind.annotation.XmlSchema;
</code></pre></div>
<p>This is important, because you need to assigns your own XML namespace for your class and all its elements.</p></section><section>
<h2><a name="Registering_Your_Class"></a>Registering Your Class</h2>
<p>Then create a configuration for the session, which registers your class with the <code>JAXBContext</code>:</p>
<p><b>This needs to be done on the requester as well as on the responder side!</b></p>

<div class="source"><pre class="prettyprint"><code class="language-java">XmppSessionConfiguration configuration = XmppSessionConfiguration.builder()
    .extensions(Extension.of(Addition.class))
    .build();
</code></pre></div>
<p>Then create the session with that configuration:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">XmppClient xmppClient = XmppClient.create(&quot;domain&quot;, configuration);
</code></pre></div></section><section>
<h2><a name="The_Requester_Side"></a>The Requester Side</h2>
<p>After having established an XMPP session the requester can then query the responder like that:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">Addition addition = new Addition(52, 22);

// Request the sum of two values (52 + 22). The requester will calculate it for you and return a result.
IQ resultIQ = xmppClient.query(IQ.get(Jid.of(&quot;responder@domain/resource&quot;), addition)).getResult();

System.out.println(resultIQ.getExtension(Addition.class));
</code></pre></div></section><section>
<h2><a name="The_Responder_Side"></a>The Responder Side</h2>
<p>In addition to registering your custom class to the session (see above), the responder needs to register an <code>IQHandler</code>
implementation, which will handle inbound requests (of type <code>Addition</code>) and return either an error or the result:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">// Reqister an IQ Handler, which will return the sum of two values.
xmppClient.addIQHandler(new IQHandler() {
    @Override
    public Class&lt;?&gt; getPayloadClass() {
        return Addition.class;
    }

    @Override
    public IQ handleRequest(IQ iq) {
        Addition addition = iq.getExtension(Addition.class);
        if (addition.getSummand1() == null) {
            // This is how you would return an error.
            return iq.createError(new StanzaError(Condition.BAD_REQUEST, &quot;No summand provided.&quot;));
        }
        return iq.createResult(new Addition(addition.getSummand1() + addition.getSummand2()));
    }
});
</code></pre></div>
<p>Preferably this should be done before connecting.</p>
<p>Each <code>IQHandler</code> is invoked in its own thread, so the result calculation could take some time without blocking any other
communication.</p>
<p>The result IQ will look like this on the XMPP stream and will eventually arrive at the requester:</p>

<div class="source"><pre class="prettyprint"><code class="language-xml">&lt;iq from=&quot;responder@domain/resource&quot; id=&quot;123&quot; to=&quot;requester@domain/resource&quot; type=&quot;result&quot;&gt;
    &lt;addition xmlns=&quot;http://xmpp.rocks&quot;&gt;
        &lt;sum&gt;74&lt;/sum&gt;
    &lt;/addition&gt;
&lt;/iq&gt;
</code></pre></div></section>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2014&#x2013;2023
<a href="http://xmpp.rocks">XMPP.rocks</a>.
All rights reserved.</p>
        </div>
      </div>
    </footer>
  </body>
</html>
