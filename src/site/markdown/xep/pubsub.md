# PubSub and PEP
---

[XEP-0060: Publish-Subscribe][PubSub] allows XMPP entities to create nodes (topics) at a pubsub service and publish information at those nodes; an event notification (with or without payload) is then broadcasted to all entities that have subscribed to the node. Pubsub therefore adheres to the classic Observer design pattern and can serve as the foundation for a wide variety of applications, including news feeds, content syndication, rich presence, geolocation, workflow systems, network management systems, and any other application that requires event notifications.

[XEP-0163: Personal Eventing Protocol][PEP] defines semantics for using the XMPP publish-subscribe protocol to broadcast state change events associated with an instant messaging and presence account.

## Working with PubSub

### Discovering pubsub services

If you don't know the address of your server\'s pubsub service, you can discover pubsub services like that:

```java
PubSubManager pubSubManager = xmppSession.getExtensionManager(PubSubManager.class);
try {
    List<Jid> pubSubServices = pubSubManager.discoverPubSubServices();
} catch (XmppException e) {
    // ...
}
```

The resulting list will contain the available pubsub services on your server. Most often it's probably only one: \"pubsub.yourdomain\".

### Using a pubsub service

If you know the address of a pubsub service (or after you have discovered it), you can now create a pubsub service like this:

```java
PubSubService pubSubService = pubSubManager.createPubSubService(Jid.valueOf("pubsub.yourdomain"));
```

The ```PubSubService``` instance allows you to perform all use cases described in [XEP-0060][PubSub]. Here are the most important of them:

#### Discovering pubsub features

Because [XEP-0060][PubSub] is quite complex and many features are optional, a pubsub service might not support all pubsub features. You can get the supported features of your service like that:

```java
Set<PubSubFeature> pubSubFeatures = pubSubService.getFeatures();
```

#### Creating a node

The following creates an \"instant\" node, i.e. the node id is generated by the service.

```java
String nodeId = pubSubService.createNode();
```


#### Publishing content to a node

The following publishes a blog entry to the node \"princely_musings\".

```java
pubSubService.publish("princely_musings", new Blog("Soliloquy"));
```

*(Note, that the above Blog class is not part of this library. It\'s merely a similar sample as used in [XEP-0060][PubSub].)*

#### Subscribing to a node

If you are interested in receiving event notifications, whenever content of a node has been updated, you have to subscribe to the node.

```java
Subscription subscription = pubSubService.subscribe("princely_musings");
```

#### Unsubscribing from a node

If you are no longer interested in receiving event notifications, you can unsubscribe from it again.

```java
pubSubService.unsubscribe("princely_musings");
```

### Listening for PubSub events

For now, you have to just deal directly with the messages. This may change in the future.

```java
xmppSession.addMessageListener(new MessageListener() {
    @Override
    public void handle(MessageEvent e) {
        if (e.isIncoming()) {
            Message message = e.getMessage();
            PubSubEvent pubSubEvent = message.getExtension(PubSubEvent.class);
            if (pubSubEvent != null) {
                List<Item> items = pubSubEvent.getItems();
                // get item from items.
            }
        }
    }
});
```

## Working with the Personal Eventing Protocol

The [personal eventing protocol][PEP] (PEP) is a subset of pubsub. For every instant messaging account a pubsub service is automatically created, which is then referred to as Personal Eventing Service. By default your contacts are automatically added as subscribers to every node.

It is used, if you want to publish your [location][GeoLocation], [tune][Tune], [mood][Mood], [activity][Activity] or your [avatar][Avatar], so that your contacts will receive updates to these kind of information.

First you have to create the personal eventing service:

```java
PubSubService pubSubService = pubSubManager.createPersonalEventingService();
```

Note that this is also a ```PubSubService``` because PEP is just a subset of PubSub.

### Publishing user data

If you want to publish personal data to the service, you can do it in the same way as described above.

Here's a sample to publish your geo location:

```java
PubSubService pubSubService = pubSubManager.createPersonalEventingService();
pubSubService.publish("http://jabber.org/protocol/geoloc", new GeoLocation(45.44, 12.33));
```

By default (i.e. if not otherwise configured) all your contacts now receive an event notification about your new geo location.


## Dealing with PubSub errors

[PubSub][PubSub] defines multiple errors for various use cases. Those errors are an extension of stanza errors.

The following shows, how to deal with pubsub specific errors.

```java
try {
    PubSubService pubSubService = pubSubManager.createPubSubService(Jid.valueOf("pubsub.yourdomain"));
    pubSubService.subscribe("princely_musings");
} catch (XmppException e) {
    if (e instanceof StanzaException) {
        StanzaException stanzaException = (StanzaException) e;
        Object extension = stanzaException.getStanza().getError().getExtension();
        if (extension instanceof PresenceSubscriptionRequired) {
            // PubSub error <presence-subscription-required xmlns='http://jabber.org/protocol/pubsub#errors'/> occurred.
        }
    }
}
```

PubSub errors can be found in the ```org.xmpp.extension.pubsub.errors``` package.

[GeoLocation]: http://xmpp.org/extensions/xep-0080.html "XEP-0080: User Location"
[Mood]: http://xmpp.org/extensions/xep-0107.html "XEP-0107: User Mood"
[Activity]: http://xmpp.org/extensions/xep-0108.html "XEP-0108: User Activity"
[Avatar]: http://xmpp.org/extensions/xep-0084.html "XEP-0084: User Avatar"
[Tune]: http://xmpp.org/extensions/xep-0118.html "XEP-0118: User Tune"
[PubSub]: http://xmpp.org/extensions/xep-0060.html "XEP-0060: Publish-Subscribe"
[PEP]: http://xmpp.org/extensions/xep-0163.html "XEP-0163: Personal Eventing Protocol"